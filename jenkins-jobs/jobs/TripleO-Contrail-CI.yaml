- job-template:
    name: TripleO-Contrail-CI
    description: 'TripleO Contrail CI'
    defaults: global
    concurrent: true
    parameters:
      - node:
          name: SLAVE_NAME
          description: "Select slave: slave_kvm is any of KVM machines and slave0X is a specific machine."
          default-slaves:
            - slave_kvm
          allowed-slaves:
            - slave_kvm
            - slave01
            - slave02
            - slave03
          ignore-offline-nodes: true
          allowed-multiselect: false
      - choice:
          name: NUM
          description: "Enironment Number"
          choices:
            - '3'
            - '4'
            - '5'
            - '6'
      - choice:
          name: ENVIRONMENT_OS
          description: "CentOS or RHEL based installation"
          choices:
            - 'rhel'
            - 'centos'
      - choice:
          name: ENVIRONMENT_OS_VERSION
          description: "RHEL release version"
          choices:
            - '7_4'
            - '7_3'
      - choice:
          name: KEYSTONE_API_VERSION
          description: "Keystone auth api version"
          choices:
            - '3'
            - '2'
      - choice:
          name: OPENSTACK_VERSION
          description: "Version of OpenStack"
          choices:
            - 'ocata'
            - 'newton'
            - 'mitaka'
      - choice:
          name: CONTRAIL_VERSION
          description: "Version of Contrail"
          choices:
            - '4.1'
            - '4.0'
            - '3.2'
      - choice:
          name: CONTRAIL_SERIES
          description: "Series of Contrail builds (cb, release, ...)"
          choices:
            - 'release'
            - 'cb'
      - choice:
          name: AAA_MODE
          description: "aaa_mode parameter for Contrail Controller"
          choices:
            - 'cloud-admin'
            - 'rbac'
            - 'no-auth'
      - choice:
          name: AAA_MODE_ANALYTICS
          description: "analytics_aaa_mode parameter for Contrail Analytics (auto - equal to aaa_mode)"
          choices:
            - 'auto'
            - 'cloud-admin'
            - 'rbac'
            - 'no-auth'
      - bool:
          name: DPDK
          description: Deploy vRouter in DPDK mode or not.
          default: false
      - bool:
          name: TSN
          description: Deploy vRouter in TSN mode or not.
          default: false
      - choice:
          name: CONTROLLER_COUNT
          description: "Count of OS controllers to deploy"
          choices:
            - '1'
            - '3'
            - '5'
      - choice:
          name: CONTRAIL_CONTROLLER_COUNT
          description: Count of contrail controllers to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
          choices:
            - '1'
            - '3'
            - 'controller'
      - choice:
          name: CONTRAIL_ANALYTICS_COUNT
          description:  Count of contrail analytics to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
                        contrail-controller - deploy to Contrail controller node
          choices:
            - '1'
            - '3'
            - 'contrail-controller'
            - 'controller'
      - choice:
          name: CONTRAIL_ANALYTICSDB_COUNT
          description:  Count of contrail analytics DB to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
                        contrail-controller - deploy to dedicated Contrail controller node
          choices:
            - '1'
            - '3'
            - 'contrail-controller'
            - 'controller'
      - choice:
          name: CLEAN_ENV
          choices:
            - 'auto'
            - 'before_only'
            - 'always'
            - 'never'
      - bool:
          name: RHEL_CERT_TEST
          description: Prepare one more VM with RH certification server or not.
          default: false
      - bool:
          name: USE_DEVELOPMENT_PUPPETS
          description: Clone puppets from internal repositories or use build's version
          default: true

    scm:
      - juniper-ci
    builders:
      - shell: |
          #!/bin/bash -e
          desc="${SLAVE_NODE}-${ENVIRONMENT_OS}-${ENVIRONMENT_OS_VERSION} $CONTRAIL_VERSION $OPENSTACK_VERSION auth${KEYSTONE_API_VERSION}"
          if [[ "$USE_DEVELOPMENT_PUPPETS" == 'true' ]] ; then
            desc+=' devl'
          fi
          if [[ "$DPDK" == 'true' ]] ; then
            desc+=' dpdk'
          fi
          if [[ "$TSN" == 'true' ]] ; then
            desc+=' tsn'
          fi
          desc+=' $AAA_MODE'
          if [[ "$AAA_MODE_ANALYTICS" != 'auto' ]] ; then
            desc+="/${AAA_MODE_ANALYTICS}"
          fi
          if [[ "$RHEL_CERT_TEST" == 'true' ]] ; then
            if [[ "$ENVIRONMENT_OS" != 'rhel' ]] ; then
              echo "RedHat Certification is available only for RHEL environment"
              exit -1
            fi
            desc+=" rhcert"
          fi
          desc+=" (num=$NUM osc=$CONTROLLER_COUNT cc=$CONTRAIL_CONTROLLER_COUNT ca=$CONTRAIL_ANALYTICS_COUNT cadb=$CONTRAIL_ANALYTICSDB_COUNT, $CLEAN_ENV)"
          echo "DESCRIPTION $desc"
      - description-setter:
          regexp: "DESCRIPTION (.*)"
      - shell: |
          #!/bin/bash -ex
          if [[ "$AAA_MODE_ANALYTICS" == 'auto' ]] ; then
            export AAA_MODE_ANALYTICS=$AAA_MODE
          fi
          if [[ "$DPDK" == 'true' && "$TSN" == 'true' ]] ; then
            echo "ERROR: DPDK and TSN cannot be enabled together"
            exit -1
          fi
          ./juniper-ci/tripleo/run-contrail.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: 'true'

- job:
    name: TripleO-Destroy-Environment
    description: 'Destroyes TripleO environment by NUM on baremetal slave'
    defaults: global
    concurrent: true
    parameters:
      - node:
          name: SLAVE_NAME
          description: "Select slave: slave0X is a specific machine."
          allowed-slaves:
            - slave01
            - slave02
            - slave03
          ignore-offline-nodes: true
          allowed-multiselect: false
      - choice:
          name: NUM
          description: "Enironment Number"
          choices:
            - '3'
            - '4'
            - '5'
            - '6'
    scm:
      - juniper-ci
    builders:
      - shell: |
          #!/bin/bash -ex
          export LIBVIRT_DEFAULT_URI=qemu:///system
          ./juniper-ci/tripleo/clean_env.sh
